<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro | Gerente</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:ital,opsz,wght@0,6..12,200..1000;1,6..12,200..1000&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./css/CadDash.css">
    <script src="./js/sessao.js"></script>
</head>
<body onload="atualizarFeed()">
    <div class="content">
        <button class="hamburger" onclick="toggleNavbar()">
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
        </button>
        <nav id="navMenu" class="nav-menu">
            <button class="close-btn" onclick="toggleNavbar()">
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
            </button>

            <img src="imagens/SecurePass SVGLogoNavBar.svg" alt="Logo" class="logo">

            <div class="separator"></div>

            <div class="nav-links">
                <a href="#">Gestão Gerente</a>
                <a href="#">Home/Página Principal</a>
                <a href="#">Perfil</a>
            </div>

            <a href="#" class="logout">Sair</a>
        </nav>
    </div>

    <div class="geral">
        <div class="formulario">
            <h2>Cadastro - Gerente</h2>
            <input id="input_nomeGerente" type="text" placeholder="Nome Completo">
            <br>
            <br>
            <input id="input_cpfGerente" type="text" placeholder="CPF">
            <br>
            <br>
            <input id="input_emailGerente" type="text" placeholder="Email">
            <br>
            <br>
            <input id="input_senhaGerente" type="password" placeholder="Senha">   
            <br>    
            <br>
            <button class="botao" onclick="cadastrarGerente()">Cadastrar Gerente</button>
            <br>
            <br>
            <div class="mensagem"></div>
        </div>
        <div class="historico">
            <div class="titulohistorico">
                <p>Gerentes já cadastrados:</p>
            </div>
            <div class="espacolista">
                <div class="espacopesquisa">
                    <div class="search-container">
                        <input type="text" placeholder="Pesquisar">
                        <button type="submit">
                            <img src="" alt="Pesquisar">
                        </button>
                    </div>
                </div>
                <div class="listagerentes" id="listagerentes">
                </div>
            </div>
        </div>
    </div>

    <script>
        function atualizarFeed() {
        fetch("/avisos/listar")
            .then(function (resposta) {
                if (resposta.ok) {
                    if (resposta.status === 204) {
                        const lista = document.getElementById("listagerentes");
                        lista.innerHTML = "<p>Nenhum resultado encontrado.</p>";
                        throw "Nenhum resultado encontrado!";
                    }

                    return resposta.json();
                } else {
                    throw "Houve um erro na API!";
                }
            })
            .then(function (dados) {
                console.log("Dados recebidos: ", JSON.stringify(dados));
                var lista = document.getElementById("listagerentes");
                lista.innerHTML = ""; // Limpa a lista antes de adicionar novos itens

                dados.forEach((card) => {
                    // Criação dos elementos do card
                    var divCard = document.createElement("a");
                    divCard.className = "linklista";
                    divCard.href = "#"; // Evita href vazio

                    var divCardGerente = document.createElement("div");
                    divCardGerente.className = "cardgerente";

                    var divFotoeNome = document.createElement("div");
                    divFotoeNome.className = "fotoenome";

                    var imgPerfil = document.createElement("img");
                    imgPerfil.src = "./imagens/perfil.svg";
                    imgPerfil.alt = "Foto de perfil";

                    var nome = document.createElement("p");
                    nome.innerText = card.nome; // Atribui o nome ao <p>

                    var status = document.createElement("div");
                    status.className = "status";

                    var statusAtivoInativo = document.createElement("p");
                    statusAtivoInativo.innerText = card.stats; // Atribui o status ao <p>

                    // Monta o card
                    divFotoeNome.appendChild(imgPerfil);
                    divFotoeNome.appendChild(nome);

                    status.appendChild(statusAtivoInativo);

                    divCardGerente.appendChild(divFotoeNome);
                    divCardGerente.appendChild(status);

                    divCard.appendChild(divCardGerente);

                    // Adiciona o card à lista
                    lista.appendChild(divCard);
                });
            })
            .catch(function (erro) {
                console.error(erro);

                // Exibe uma mensagem de erro amigável
                const lista = document.getElementById("listagerentes");
                lista.innerHTML = `<p>Erro ao carregar os gerentes: ${erro}</p>`;
            });
    }

        function toggleNavbar() {
            const navMenu = document.getElementById('navMenu');
            const hamburger = document.querySelector('.hamburger');

            if (navMenu.classList.contains('show')) {
                navMenu.classList.remove('show');
                hamburger.style.left = '10px'; 
            } else {
                navMenu.classList.add('show');
                hamburger.style.left = '260px'; 
            }
        }

        function cadastrarGerente() {
            var nomeGerenteVar = input_nomeGerente.value;
            var emailGerenteVar = input_emailGerente.value;
            var senhaGerenteVar = input_senhaGerente.value;
            var cpfGerenteVar = input_cpfGerente.value;

            var representante = sessionStorage.getItem("ID_USUARIO");
            var fkNR = sessionStorage.getItem("NR_EMPRESA");

            if (
                nomeGerenteVar == "" ||
                emailGerenteVar == "" ||
                senhaGerenteVar == "" ||
                cpfGerenteVar == ""
            ) {
                window.alert("Campos não devidamente preenchidos");
                return;
            } else if (senhaGerenteVar.length < 8) {
                window.alert("A senha deve ter 8 ou mais caracteres");
                return;
            } 

            fetch("/usuarios/cadastrarGerente", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    nomeGerenteServer: nomeGerenteVar,
                    cpfGerenteServer: cpfGerenteVar,
                    emailGerenteServer: emailGerenteVar,
                    senhaGerenteServer: senhaGerenteVar,
                    representanteServer: representante,
                    fkNRServer: fkNR
                }),
            })
            .then(function (resposta) {
                console.log("resposta: ", resposta);

                if (resposta.ok) {
                    window.alert("Cadastro de Gerente Realizado com sucesso");
                } else {
                    throw "Houve um erro ao tentar realizar o cadastro!";
                }
            })
            .catch(function (erro) {
                console.error("#ERRO: ", erro);
            });

            return false;
        }
    </script>
</body>
</html>