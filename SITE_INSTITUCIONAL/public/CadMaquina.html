<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Nunito+Sans:ital,opsz,wght@0,6..12,200..1000;1,6..12,200..1000&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="./css/CadMaq.css">
    <title>Cadastro de Máquina | SecurePass</title>
</head>

<body onload="atualizarLista()">
    <section class="edit_pai" id="secao_pai" style="display: none;">
        <div class="edit_data">
            <div class="fechar">
                <button class="botao_fechar_edit" onclick="fecharJanela()"></button>
            </div>
            <h1>Dados da Máquina</h1>
            <div class="edit_campos">
                <div class="atualizar_dispositivo">
                    <div class="input-container">
                        <label for="input_nome_update">Nome da Máquina:</label>
                        <input id="input_nome_update" type="text" placeholder="Nome da Máquina (deve ser único)">
                    </div>
                    <div class="input-container">
                        <label for="input_ipCatraca_update">IPV4 da catraca exemplar:</label>
                        <input id="input_ipCatraca_update" type="text"
                            placeholder="IP da catraca exemplar para métricas">
                    </div>

                    <button class="botao" id="botao_atualizar">Atualizar máquina</button>
                </div>
                <hr>
                <div>
                    <div class="limites">
                        <h1>Definição de limites</h1>
                        <div class="cadastro">
                            <div class="items">
                                <div class="input-container">
                                    <label for="input_PerdaPacote">Perda de Pacotes:</label>
                                    <input id="input_PerdaPacote" type="text" placeholder="Limite de perda de pacotes (%)">
                                </div>

                                <div class="input-container">
                                    <label for="input_CPU">Limite CPU:</label>
                                    <input id="input_CPU" type="text" placeholder="Limite máximo de uso da CPU (em %)">
                                </div>

                                <div class="input-container">
                                    <label for="input_FreqCPU">Limite frequência CPU:</label>
                                    <input id="input_FreqCPU" type="text"
                                        placeholder="Limite mínimo de frequência da CPU (em GHz)">
                                </div>

                                <div class="input-container">
                                    <label for="input_TempoResposta">Limite tempo de resposta:</label>
                                    <input id="input_TempoResposta" type="text"
                                        placeholder="Limite máximo de tempo de resposta (em ms)">
                                </div>

                            </div>
                            <div class="items">
                                <div class="input-container">
                                    <label for="input_UploadRede">Limite de upload rede:</label>
                                    <input id="input_UploadRede" type="text"
                                        placeholder="Limite mínimo de uso de rede (em Mb/s)">
                                </div>

                                <div class="input-container">
                                    <label for="input_DownloadRede">Limite de download rede:</label>
                                    <input id="input_DownloadRede" type="text"
                                        placeholder="Limite mínimo de uso de rede (em Mb/s)">
                                </div>

                                <div class="input-container">
                                    <label for="input_RAM">Limite RAM:</label>
                                    <input id="input_RAM" type="text" placeholder="Limite máximo de uso de RAM (em %)">
                                </div>

                                <div class="input-container">
                                    <label for="input_disco">Limite Disco:</label>
                                    <input id="input_disco" type="text"
                                        placeholder="Limite máximo de uso de Disco (em %)">
                                </div>

                            </div>
                        </div>


                        <button class="botao" id="botao_limite">Adicionar limites</button>

                        <div class="botao_status">
                            <button class="botao" id="botao_ativar">Ativar Máquina</button>
                            <button class="botao_deletar" id="botao_desativar">Desativar Máquina</button>
                        </div>

                    </div>

                </div>
            </div>
        </div>
    </section>
    <div class="content">
        <button class="hamburger" onclick="Navbar()">
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
        </button>
        <nav id="navMenu" class="nav-menu">
            <button class="close-btn" onclick="Navbar()">
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
            </button>

            <img src="imagens/SecurePass SVGLogoNavBar.svg" alt="Logo" class="logo">

            <div class="separator"></div>

            <div class="nav-links">
                <a href="./CadTecnicoSuporte.html">Gestão TS</a>
                <a href="./dashGerente.html">Dashboard</a>
                <a href="./CadMaquina.html">Gestão de Máquinas</a>
                <a href="./dadosUsuario.html">Perfil</a>
                <a href="./feedbackPublicar.html">Feedback</a>
            </div>

            <a href="index.html" class="logout">Sair</a>
        </nav>
    </div>

    <div class="geral">
        <div class="formulario">
            <h2>Cadastro de Máquina</h2>

            <div class="cadastro">
                <div class="items_cadastro">
                    <div class="input-container">
                        <label for="input_nome">Nome da Máquina:</label>
                        <input id="input_nome" type="text" placeholder="Nome da Máquina (deve ser único)">
                    </div>

                    <div class="input-container">
                        <label for="input_ipCatraca">IPV4 da Catraca exemplar:</label>
                        <input id="input_ipCatraca" type="text" placeholder="IP da catraca exemplar para métricas">
                    </div>

                </div>

            </div>

            <button class="botao" onclick="cadastrar()">Adicionar máquina</button>

            <p>Antes de executar a aplicação na máquina, defina os limites de cada componente na edição de máquina!</p>

            <div id="div_mensagem" class="mensagem"></div>
        </div>
        <div class="historico">
            <div class="titulohistorico">
                <p>Máquinas já cadastradas:</p>
            </div>
            <div class="espacolista">
                <div class="espacopesquisa" id="espacopesquisa">
                    <div class="search-container">
                        <input type="text" id="input_pesquisa" placeholder="Pesquisar nome">
                        <button type="submit" style="right: 1px;" onclick="pesquisaMaquina()">
                            <img src="./imagens/lupa.png" alt="Pesquisar">
                        </button>
                    </div>
                </div>
                <div class="listagerentes" id="listamaquinas">
                </div>
            </div>
        </div>
    </div>
</body>

</html>
<script>

    function Navbar() {
        const navMenu = document.getElementById('navMenu');
        const hamburger = document.querySelector('.hamburger');

        if (navMenu.classList.contains('show')) {
            navMenu.classList.remove('show');
            hamburger.style.left = '10px';
        } else {
            navMenu.classList.add('show');
            hamburger.style.left = '260px';
        }
    }

    function atualizarLista() {
        var fkLinha = sessionStorage.getItem("LINHA");

        fetch("/avisos/listarMaquina", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                linhaSever: fkLinha
            }),
        })
            .then(function (resposta) {
                if (resposta.ok) {
                    if (resposta.status == 204) {
                        var lista = document.getElementById("listamaquinas");
                        lista.className = "lista";
                        lista.innerHTML = "<p>Ainda não há nenhuma máquina cadastrada.</p>";
                        return [];
                    }
                    return resposta.json();
                } else {
                    throw "Houve um erro na API!";
                }
            })
            .then(function (dados) {
                console.log("Dados recebidos: ", JSON.stringify(dados));
                var lista = document.getElementById("listamaquinas");
                lista.innerHTML = "";

                if (dados.length == 0) {
                    lista.innerHTML = "<p>Ainda não há nenhuma máquina cadastrada.</p>";
                    return;
                }

                for (let i = 0; i < dados.length; i++) {
                    var card = dados[i];

                    var divCard = document.createElement("a");
                    divCard.className = "linklista";


                    var divCardMaquina = document.createElement("div");
                    divCardMaquina.className = "cardgerente";

                    divCardMaquina.dataset.idDispositivo = card.idDispositivo;
                    divCardMaquina.dataset.fkLinha = card.fkLinha;
                    divCardMaquina.dataset.nome = card.nome;
                    divCardMaquina.dataset.status = card.status;

                    divCardMaquina.addEventListener("click", function () {
                        var maquina = {
                            idDispositivo: this.dataset.idDispositivo,
                            fkLinha: this.dataset.fkLinha,
                            nome: this.dataset.nome,
                            status: this.dataset.status
                        };
                        salvarMaquinaNoLocalStorage(maquina);
                        console.log(card.idDispositivo)
                        console.log(maquina.idDispositivo)
                        editar(maquina.idDispositivo)
                    });

                    var divFotoeNome = document.createElement("div");
                    divFotoeNome.className = "fotoenome";

                    var imgPerfil = document.createElement("img");
                    imgPerfil.src = "./imagens/vetorservidor.svg";
                    imgPerfil.alt = "Foto de perfil";

                    var nome = document.createElement("p");
                    nome.innerText = card.nome;

                    var status = document.createElement("div");
                    status.className = "status";

                    var statusAtivoInativo = document.createElement("p");

                    if (card.status == '1') {
                        statusAtivoInativo.innerText = "ATIVO"

                        statusAtivoInativo.style.color = "black";
                    } else if (card.status == '0') {
                        statusAtivoInativo.innerText = "INATIVO"

                        statusAtivoInativo.style.color = "red";
                    }

                    divFotoeNome.appendChild(imgPerfil);
                    divFotoeNome.appendChild(nome);
                    status.appendChild(statusAtivoInativo);
                    divCardMaquina.appendChild(divFotoeNome);
                    divCardMaquina.appendChild(status);
                    divCard.appendChild(divCardMaquina);
                    lista.appendChild(divCard);
                }
            })
            .catch(function (erro) {
                console.error(erro);

                const lista = document.getElementById("listamaquinas");
                lista.innerHTML = `<p>Erro ao carregar os gerentes: ${erro}</p>`;
            });
    }

    function pesquisaMaquina() {
        var pesquisa = input_pesquisa.value;
        var fkLinha = sessionStorage.getItem("LINHA");

        if (pesquisa == "") {
            window.alert("Preencha corretamente o campo de pesquisa");
            return;
        }

        var lista = document.getElementById("listamaquinas");
        lista.innerHTML = "";

        fetch("/avisos/pesquisaMaquina", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                pesquisaServer: pesquisa,
                linhaServer: fkLinha
            }),
        })
            .then(function (resposta) {
                if (resposta.status == 204) {
                    adicionarBotaoLimparPesquisa();
                    return [];
                }
                return resposta.json();
            })
            .then(function (respostaJson) {
                console.log("Dados recebidos: ", respostaJson);
                var lista = document.getElementById("listamaquinas");
                lista.innerHTML = "";

                if (respostaJson.length > 0) {
                    for (let i = 0; i < respostaJson.length; i++) {
                        var card = respostaJson[i];

                        var divCard = document.createElement("a");
                        divCard.className = "linklista";


                        var divCardMaquina = document.createElement("div");
                        divCardMaquina.className = "cardgerente";

                        divCardMaquina.dataset.idDispositivo = card.idDispositivo;
                        divCardMaquina.dataset.fkLinha = card.fkLinha;
                        divCardMaquina.dataset.nome = card.nome;
                        divCardMaquina.dataset.status = card.status;

                        divCardMaquina.addEventListener("click", function () {
                            var maquina = {
                                idDispositivo: this.dataset.idDispositivo,
                                fkNR: this.dataset.fkNR,
                                nome: this.dataset.nome,
                                status: this.dataset.status
                            };
                            salvarMaquinaNoLocalStorage(maquina);
                            editar(maquina.idDispositivo)
                        });

                        var divFotoeNome = document.createElement("div");
                        divFotoeNome.className = "fotoenome";

                        var imgPerfil = document.createElement("img");
                        imgPerfil.src = "./imagens/vetorservidor.svg";
                        imgPerfil.alt = "Foto de perfil";

                        var nome = document.createElement("p");
                        nome.innerText = card.nome;

                        var status = document.createElement("div");
                        status.className = "status";

                        var statusAtivoInativo = document.createElement("p");

                        if (card.status == '1') {
                            statusAtivoInativo.innerText = "ATIVO"

                            statusAtivoInativo.style.color = "black";
                        } else if (card.status == '0') {
                            statusAtivoInativo.innerText = "INATIVO"

                            statusAtivoInativo.style.color = "red";
                        }

                        divFotoeNome.appendChild(imgPerfil);
                        divFotoeNome.appendChild(nome);
                        status.appendChild(statusAtivoInativo);
                        divCardMaquina.appendChild(divFotoeNome);
                        divCardMaquina.appendChild(status);
                        divCard.appendChild(divCardMaquina);
                        lista.appendChild(divCard);
                    }
                } else {
                    lista.innerHTML = `<p style="color: #FCFFFC">Não existe nenhuma máquina com esse nome.</p>`;
                }

                adicionarBotaoLimparPesquisa();
            })
            .catch(function (erro) {
                console.error("#ERRO: ", erro);
            });

        return false;
    }

    function salvarMaquinaNoLocalStorage(maquina) {
        localStorage.setItem("maquinaSelecionado", JSON.stringify(maquina));
    }

    function adicionarBotaoLimparPesquisa() {
        var container = document.getElementById("espacopesquisa");

        if (!document.getElementById("botaoLimpar")) {
            var botaoLimpar = document.createElement("button");
            botaoLimpar.className = "botão_limpar";
            botaoLimpar.id = "botaoLimpar";
            botaoLimpar.innerText = "Limpar Pesquisa";
            botaoLimpar.onclick = limparPesquisa;
            container.appendChild(botaoLimpar);
        }
    }

    function limparPesquisa() {
        var inputPesquisa = document.getElementById("input_pesquisa");
        inputPesquisa.value = "";

        var lista = document.getElementById("listamaquinas");
        lista.innerHTML = "";

        var botaoLimpar = document.getElementById("botaoLimpar");
        if (botaoLimpar) {
            botaoLimpar.remove();
        }

        atualizarLista();
    }

    function cadastrar() {
        var nomeVar = input_nome.value;
        var fkLinhaVar = sessionStorage.LINHA;
        var ipCatracaVar = input_ipCatraca.value;

        if (
            nomeVar == "" || ipCatracaVar == ""
        ) {
            window.alert('Campos não devidamente preenchidos.')
        } else {
            fetch("/maquinas/cadastrar", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    nomeServer: nomeVar,
                    fkLinhaServer: fkLinhaVar,
                    ipCatracaServer: ipCatracaVar
                }),
            })
                .then((resposta) => resposta.json())
                .then((data) => {
                    if (data.idDispositivo) {
                        // Exibe o ID do dispositivo para confirmar que foi recebido
                        console.log("ID do dispositivo cadastrado:", data.idDispositivo);
                        window.alert(`Máquina cadastrada com sucesso! ID: ${data.idDispositivo}`);

                        // Aqui você pode chamar uma função para cadastrar os limites usando o `idDispositivo`
                        cadastrarLimites(data.idDispositivo);

                        atualizarLista();
                    } else {
                        throw "Houve um erro ao tentar realizar o cadastro!";
                    }
                })
                .catch(function (resposta) {
                    console.log(`#ERRO: ${resposta}`);
                });

            input_nome.value = "";
            input_ipCatraca.value = "";

            return false;
        }
    }

    function cadastrarLimites(idDispositivo) {
        var limitePercCPU = 80.0;
        var limitePercMEM = 75.0;
        var limitePercDISCO = 90.0;
        var limiteRedeEnviada = 1000.0;
        var limiteRedeRecebida = 1000.0;
        var limiteFreqCPU = 3.5;
        var limitePerdaPacote = 10.0;
        var limiteTempoResposta = 200.0;
        var fkLinha = sessionStorage.LINHA;
        
        
            fetch("/limites/cadastrar", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    percCPUServer: limitePercCPU,
                    percCPUServer: limitePercCPU,
                    percMEMServer: limitePercMEM,
                    percDISCOServer: limitePercDISCO,
                    redeEnviadaServer: limiteRedeEnviada,
                    redeRecebidaServer: limiteRedeRecebida,
                    freqCPUServer: limiteFreqCPU,
                    perdaPacoteServer: limitePerdaPacote,
                    tempoRespostaServer: limiteTempoResposta,
                    idDispositivoServer: idDispositivo,
                    fkLinhaServer: fkLinha
                }),
            })
            .then(function (resposta) {
                console.log("resposta: ", resposta);

                if (resposta.ok) {
                    console.log("Limites definidos com sucesso.")
                    atualizarLista();
                } else {
                    throw "Houve um erro ao tentar realizar o cadastro!";
                }
            })
                .catch(function (resposta) {
                    console.log(`#ERRO: ${resposta}`);
                });

    }

    function fecharJanela() {
        secao_pai.style.display = "none"

        input_CPU.value = "" 
        input_PerdaPacote.value = "" 
        input_FreqCPU.value = "" 
        input_TempoResposta.value = "" 
        input_UploadRede.value = "" 
        input_DownloadRede.value = "" 
        input_RAM.value = "" 
        input_disco.value = "" 

        input_nome_update.value = ""
        input_ipCatraca_update.value = ""
    }

    function editar(idDispositivo) {
        secao_pai.style.display = "flex"

        botao_atualizar.onclick = () => atualizarMaquina(idDispositivo);
        botao_limite.onclick = () => definirLimite(idDispositivo);
        botao_ativar.onclick = () => ativarMaquina(idDispositivo);
        botao_desativar.onclick = () => desativarMaquina(idDispositivo);

    }

    function atualizarMaquina(idDispositivo) {
        var nomeVar = input_nome_update.value;
        var ipCatracaVar = input_ipCatraca_update.value;

        if (
            nomeVar == "" || ipCatracaVar == ""
        ) {
            window.alert('Campos não devidamente preenchidos.')
        } else {
            fetch("/maquinas/atualizar", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    nomeServer: nomeVar,
                    ipCatracaServer: ipCatracaVar,
                    idDispositivoServer: idDispositivo
                }),
            })
                .then(function (resposta) {
                    console.log("resposta: ", resposta);

                    if (resposta.ok) {
                        window.alert('Máquina atualizada com sucesso')
                        atualizarLista();
                    } else {
                        throw "Houve um erro ao tentar realizar o cadastro!";

                        div_mensagem.innerHTML = "Já existe uma máquina com esse mesmo nome!"
                    }
                })
                .catch(function (resposta) {
                    console.log(`#ERRO: ${resposta}`);
                });

            input_nome_update.value = "";
            input_ipCatraca_update.value = ""

            return false;
        }
    }

    function ativarMaquina(idDispositivo) {

        if (
            idDispositivo == ""
        ) {
            window.alert('Erro com id da máquina.')
        } else {
            fetch("/maquinas/ativarMaquina", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    idDispositivoServer: idDispositivo
                }),
            })
                .then(function (resposta) {
                    console.log("resposta: ", resposta);

                    if (resposta.ok) {
                        window.alert('Máquina ativada!')
                        atualizarLista();
                    } else {
                        throw "Houve um erro ao tentar ativar a máquina!";
                    }
                })
                .catch(function (resposta) {
                    console.log(`#ERRO: ${resposta}`);
                });

            return false;
        }
    }

    function desativarMaquina(idDispositivo) {

        if (
            idDispositivo == ""
        ) {
            window.alert('Erro com id da máquina.')
        } else {
            fetch("/maquinas/desativarMaquina", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    idDispositivoServer: idDispositivo
                }),
            })
                .then(function (resposta) {
                    console.log("resposta: ", resposta);

                    if (resposta.ok) {
                        window.alert('Máquina desativada!')
                        atualizarLista();
                    } else {
                        throw "Houve um erro ao tentar ativar a máquina!";
                    }
                })
                .catch(function (resposta) {
                    console.log(`#ERRO: ${resposta}`);
                });


            return false;
        }
    }

    function definirLimite(idDispositivo){
        var limitePercCPU = Number(input_CPU.value);
        var limitePercMEM = Number(input_RAM.value);
        var limitePercDISCO = Number(input_disco.value);
        var limiteRedeEnviada = Number(input_UploadRede.value);
        var limiteRedeRecebida = Number(input_DownloadRede.value);
        var limiteFreqCPU = Number(input_FreqCPU.value);
        var limitePerdaPacote = Number(input_PerdaPacote.value);
        var limiteTempoResposta = Number(input_TempoResposta.value);
        
        if( isNaN(limitePercCPU) ||
            isNaN(limitePercMEM) ||
            isNaN(limitePercDISCO) ||
            isNaN(limiteRedeEnviada) ||
            isNaN(limiteRedeRecebida) ||
            isNaN(limiteFreqCPU) ||
            isNaN(limitePerdaPacote) ||
            isNaN(limiteTempoResposta))
            {
                alert("Por favor, insira apenas números nos limites!")

        }else if(!input_CPU.value || 
        !input_RAM.value || 
        !input_disco.value ||
        !input_UploadRede.value || 
        !input_DownloadRede.value ||
        !input_FreqCPU.value || 
        !input_PerdaPacote.value || 
        !input_TempoResposta.value)
        {
            alert("Por favor, preencha todos os campos para adicionar os limites!")
        } else{
            
            fetch("/limites/atualizar", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    percCPUServer: limitePercCPU,
                    percMEMServer: limitePercMEM,
                    percDISCOServer: limitePercDISCO,
                    redeEnviadaServer: limiteRedeEnviada,
                    redeRecebidaServer: limiteRedeRecebida,
                    freqCPUServer: limiteFreqCPU,
                    perdaPacoteServer: limitePerdaPacote,
                    tempoRespostaServer: limiteTempoResposta,
                    idDispositivoServer: idDispositivo
                }),
            })
            .then(function (resposta) {
                console.log("resposta: ", resposta);

                if (resposta.ok) {
                    window.alert("Limites definidos com sucesso.")
                    input_CPU.value = "" 
                    input_PerdaPacote.value = "" 
                    input_FreqCPU.value = "" 
                    input_TempoResposta.value = "" 
                    input_UploadRede.value = "" 
                    input_DownloadRede.value = "" 
                    input_RAM.value = "" 
                    input_disco.value = "" 
                    atualizarLista();
                } else {
                    throw "Houve um erro ao tentar realizar o cadastro!";
                }
            })
                .catch(function (resposta) {
                    console.log(`#ERRO: ${resposta}`);
                });
        }

    }

</script>