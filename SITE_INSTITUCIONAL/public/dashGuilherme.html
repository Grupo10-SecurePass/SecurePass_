<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Gerente</title>
    <link rel="stylesheet" href="./css/dashGuilherme.css">
</head>

<style>
    /* Estilos básicos */
    .hidden {
        display: none;
    }
</style>

<body>
    <!-- Fundo ofuscado -->
    <div class="fundo-ofuscado"></div>

    <div class="container">
        <nav class="nav-menu">
            <img src="Imagens/SecurePass SVGLogoNavBar 1.png" alt="Logo" class="logo">
            <div class="separator"></div>
            <div class="nav-links">
                <a href="./dashGerente.html"><img src="Imagens/bar-chart (3).png" alt="Icon"
                        class="nav-icon">Dashboard</a>
                <a href="./dadosUsuario.html"><img src="Imagens/user.png" alt="Icon" class="nav-icon">Perfil</a>
                <a href="./feedbackPublicar.html"><img src="Imagens/feedback (1).png" alt="Icon"
                        class="nav-icon">Feedback</a>
                <br><br><br><br><br><br><br><br><br><br><br><br><br>
                <a href="index.html"><img src="Imagens/logout.png" alt="Icon" class="nav-icon">Sair</a>
            </div>
        </nav>

        <div class="dashboard-content">
            <div class="header">
                <h1>Dashboard</h1>
                <div class="linha-input">
                    <input id="pergunta" type="text" placeholder="Digite a sua dúvida!">
                    <button onclick="gerarResposta()" class="botao-colorido visualizar">Pesquisar</button>
                    <button id="gerarRelatorio" class="botao-colorido visualizar">Gerar Relátorio</button>
                </div>
                <div class="user-info">
                    <div class="name">Exemplo Nome</div>
                    <div class="role">Técnico de Suporte</div>
                </div>
                <div class="profile-icon">
                    <a href="./dadosGerente.html"><img src="Imagens/profile-user.png" alt="Icon" class="Icon">Perfil</a>
                </div>
            </div>

            <!-- Card de resposta -->
            <div id="resposta" class="resposta-card">
                <img src="Imagens/close.png" alt="Fechar" class="fechar-icone" onclick="fecharResposta()">
                <div class="resposta-texto">
                    <span id="resposta-texto"></span>
                </div>
            </div>

            <div class="main-content">
                <div class="grafico-principal">
                    <canvas id="centralChart" width="400" height="400"></canvas>
                    <div class="botoes-acao">
                        <button id="btn-cpu" class="botao-colorido verde">CPU</button>
                        <button id="btn-ram" class="botao-colorido verde">RAM</button>
                        <button id="btn-alertas" class="botao-colorido vermelho">ALERTAS</button>
                    </div>
                </div>
                <div class="grafico-lateral">
                    <canvas id="circularChart"></canvas>
                </div>
            </div>

            <div id="ramSection" class="hidden">
                <div class="main-content">
                    <div class="grafico-principal">
                        <canvas id="downloadChart" width="400" height="400"></canvas>
                        <div class="botoes-acao">
                            <button id="btn-cpu2" class="botao-colorido verde">CPU</button>
                            <button id="btn-ram2" class="botao-colorido verde">RAM</button>
                            <button id="btn-alertas2" class="botao-colorido vermelho">ALERTAS</button>
                        </div>
                    </div>
                    <div class="grafico-lateral">
                        <canvas id="newBarChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="alertSection" class="hidden">
                <div class="alert-cards">
                    <div class="alert-card">
                        <img src="Imagens/warning.png" alt="Alerta" class="alert-icon">
                        <div id="alertaCritico" class="alert-text">Alertas Críticos</div>
                    </div>
                    <div class="alert-card">
                        <div id="tempAlerta" class="alert-text">Porcentagem em alerta durante o dia: <span
                                style="color: red; font-weight: bold;">XX%</span></div>
                    </div>
                    <div class="alert-card">
                        <div id="tempEstavel" class="alert-text">Porcentagem estável durante o dia: <span
                                style="color: green; font-weight: bold;">XX%</span></div>
                    </div>
                </div>

                <div class="alert-content">
                    <div class="alert-graph">
                        <canvas id="alertPieChart" width="250" height="210"></canvas>
                    </div>
                    <div class="alert-details">
                        <div class="alert-detail-card">
                            <div class="alert-buttons">
                                <button id="btn-back-cpu" class="botao-colorido verde">CPU</button>
                                <button id="btn-back-ram" class="botao-colorido verde">RAM</button>
                                <button id="btn-back-alertas" class="botao-colorido vermelho">ALERTAS</button>
                            </div>
                        </div>
                        <div id="alert-details-container" class="alert-details">
                            <!-- O conteúdo dos alertas será inserido aqui -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>



<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>

    window.onload = function () {
        let chartInstance = null; // Variável para armazenar a instância do gráfico de linha (CPU)
        let barChartInstance = null; // Variável para armazenar a instância do gráfico de barras (circularChart) CPU
        let ramChartInstance = null; // Variável para o gráfico de linha (RAM)
        let ramBarChartInstance = null; // Variável para o gráfico de barras (circularChart) RAM
        let alertPieChartInstance = null;
        // Função para criar o gráfico de linha (CPU)
        function createChart(data) {
            var horarios = [];
            var porcentagens = [];

            data.reverse(); // Inverte a ordem dos dados

            for (var i = 0; i < data.length; i++) {
                var item = data[i];
                horarios.push(item.horario);
                porcentagens.push(item.percentualCpu);
            }

            const pointColors = porcentagens.map(value => value > 80 ? 'red' : 'rgba(0, 0, 0, 0.7)');

            if (chartInstance) {
                chartInstance.destroy(); // Destruir o gráfico antes de criar um novo
            }

            const centralChartCtx = document.getElementById('centralChart').getContext('2d');
            chartInstance = new Chart(centralChartCtx, {
                type: 'line',
                data: {
                    labels: horarios,
                    datasets: [{
                        label: 'Uso de CPU (%)',
                        data: porcentagens,
                        borderWidth: 2,
                        backgroundColor: 'rgba(36, 130, 50, 0.7)',
                        borderColor: 'black',
                        pointBackgroundColor: pointColors,
                        pointBorderColor: 'transparent',
                        pointRadius: 2,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: { display: true, text: 'Uso (%)', font: { size: 16, weight: 'bold', color: '#000' } },
                            ticks: { font: { size: 12, weight: 'bold', color: '#000' } }
                        },
                        x: {
                            title: { display: true, text: 'Horário do Dia', font: { size: 16, weight: 'bold', color: '#000' } },
                            ticks: { font: { size: 12, weight: 'bold', color: '#000' } }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Média de uso de CPU por dia', font: { size: 20, weight: 'bold' }, color: '#000' }
                    }
                }
            });
        }

        // Função para criar o gráfico de barras (CPU)
        function updateBarChart(cpuUsagePercentage) {
            const ocioso = 100 - cpuUsagePercentage;
            const emUso = cpuUsagePercentage;

            if (!barChartInstance) {
                const barChartCtx = document.getElementById('circularChart').getContext('2d');
                barChartInstance = new Chart(barChartCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Ocioso', 'Em Uso'],
                        datasets: [{
                            data: [ocioso, emUso],
                            backgroundColor: ['rgba(36, 130, 50, 0.8)', 'rgba(255, 76, 76, 0.8)'],
                            borderColor: ['rgba(36, 130, 50, 1)', 'rgba(255, 76, 76, 1)'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, max: 100, title: { display: true, text: 'Uso (%)', font: { size: 16, weight: 'bold', color: '#000' } }, ticks: { font: { size: 12, weight: 'bold', color: '#000' } } }
                        },
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: 'Ociosidade da CPU por dia', font: { size: 20, weight: 'bold' }, color: '#000' },
                            tooltip: { titleFont: { size: 16, weight: 'bold', color: '#000' }, bodyFont: { size: 16, weight: 'bold', color: '#000' } }
                        }
                    }
                });
            } else {
                barChartInstance.data.datasets[0].data = [ocioso, emUso];
                barChartInstance.update();
            }
        }

        // Função para calcular a média de uso de CPU
        function calculateCpuUsageAverage(data) {
            const total = data.reduce((sum, item) => sum + item.percentualCpu, 0);
            const average = total / data.length;
            return average;
        }

        // Função para buscar e atualizar os dados da CPU
        function fetchDataAndUpdateChart() {
            fetch('guilherme/obterPercentualCpu')
                .then(response => response.json())
                .then(function (data) {
                    console.log("Dados recebidos do servidor (CPU):", data);

                    createChart(data);
                    const cpuUsageAverage = calculateCpuUsageAverage(data);
                    updateBarChart(cpuUsageAverage);
                })
                .catch(function (error) {
                    console.error('Erro ao obter os dados de uso da CPU:', error);
                });
        }

        // Função para calcular a média de uso de RAM
        function calculateRamUsageAverage(data) {
            const total = data.reduce((sum, item) => sum + item.percentualRam, 0);
            const average = total / data.length;
            return average;
        }

        // Função para criar o gráfico de linha (RAM)
        function createRamChart(data) {
            var horarios = [];
            var porcentagens = [];

            data.reverse(); // Inverte a ordem dos dados

            for (var i = 0; i < data.length; i++) {
                var item = data[i];
                horarios.push(item.horario);
                porcentagens.push(item.percentualRam); // Mudança para RAM
            }

            const pointColors = porcentagens.map(value => value > 80 ? 'red' : 'rgba(0, 0, 0, 0.7)');

            if (ramChartInstance) {
                ramChartInstance.destroy(); // Destruir o gráfico antes de criar um novo
            }

            const ramChartCtx = document.getElementById('downloadChart').getContext('2d');
            ramChartInstance = new Chart(ramChartCtx, {
                type: 'line',
                data: {
                    labels: horarios,
                    datasets: [{
                        label: 'Uso de RAM (%)',
                        data: porcentagens,
                        borderWidth: 2,
                        backgroundColor: 'rgba(36, 130, 50, 0.7)',
                        borderColor: 'black',
                        pointBackgroundColor: pointColors,
                        pointBorderColor: 'transparent',
                        pointRadius: 2,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true, max: 100, title: { display: true, text: 'Uso (%)', font: { size: 16, weight: 'bold', color: '#000' } }, ticks: { font: { size: 12, weight: 'bold', color: '#000' } } },
                        x: { title: { display: true, text: 'Horário do Dia', font: { size: 16, weight: 'bold', color: '#000' } }, ticks: { font: { size: 12, weight: 'bold', color: '#000' } } }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Média de uso de RAM por dia', font: { size: 20, weight: 'bold' }, color: '#000' }
                    }
                }
            });
        }

        // Função para criar ou atualizar o gráfico de barras (RAM)
        function updateRamBarChart(ramUsagePercentage) {
            const ocioso = 100 - ramUsagePercentage;
            const emUso = ramUsagePercentage;

            if (!ramBarChartInstance) {
                const ramBarChartCtx = document.getElementById('newBarChart').getContext('2d');
                ramBarChartInstance = new Chart(ramBarChartCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Ocioso', 'Em Uso'],
                        datasets: [{
                            data: [ocioso, emUso],
                            backgroundColor: ['rgba(36, 130, 50, 0.8)', 'rgba(255, 76, 76, 0.8)'],
                            borderColor: ['rgba(36, 130, 50, 1)', 'rgba(255, 76, 76, 1)'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, max: 100, title: { display: true, text: 'Uso (%)', font: { size: 16, weight: 'bold', color: '#000' } }, ticks: { font: { size: 12, weight: 'bold', color: '#000' } } }
                        },
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: 'Ociosidade da RAM por dia', font: { size: 20, weight: 'bold' }, color: '#000' },
                            tooltip: { titleFont: { size: 16, weight: 'bold', color: '#000' }, bodyFont: { size: 16, weight: 'bold', color: '#000' } }
                        }
                    }
                });
            } else {
                ramBarChartInstance.data.datasets[0].data = [ocioso, emUso];
                ramBarChartInstance.update();
            }
        }

        // Função para buscar e atualizar os dados da RAM
        function fetchDataAndUpdateRamChart() {
            fetch('guilherme/obterPercentualRam')
                .then(response => response.json())
                .then(function (data) {
                    console.log("Dados recebidos do servidor (RAM):", data);

                    createRamChart(data);
                    const ramUsageAverage = calculateRamUsageAverage(data);
                    updateRamBarChart(ramUsageAverage);
                })
                .catch(function (error) {
                    console.error('Erro ao obter os dados de uso da RAM:', error);
                });
        }

        function updateTemp() {
            fetch('guilherme/obterTempAlertas')
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        // Verifica se as chaves existem e são válidas
                        const tempAlerta = data[0]?.porcentagemAlertas;
                        const tempEstavel = data[0]?.porcentagemSemAlertas;

                        // Verifica se as variáveis de alerta e estável estão presentes
                        if (tempAlerta !== undefined && tempEstavel !== undefined) {
                            // Atualiza os textos nas divs com as porcentagens, agora sem repetir
                            document.getElementById('tempAlerta').innerHTML = `Porcentagem em alerta durante o dia: <span style="color: red; font-weight: bold;">${tempAlerta}</span>`;
                            document.getElementById('tempEstavel').innerHTML = `Porcentagem estável durante o dia: <span style="color: green; font-weight: bold;">${tempEstavel}</span>`;
                        } else {
                            // Caso as porcentagens não existam ou não sejam válidas
                            document.getElementById('tempAlerta').textContent = "Dados de tempo em alerta não disponíveis";
                            document.getElementById('tempEstavel').textContent = "Dados de tempo estável não disponíveis";
                        }
                    } else {
                        // Caso não haja dados para atualizar
                        document.getElementById('tempAlerta').textContent = "Sem dados de alerta";
                        document.getElementById('tempEstavel').textContent = "Sem dados de tempo estável";
                    }
                })
                .catch(error => {
                    console.error("Erro ao buscar dados de alertas:", error);
                    document.getElementById('tempAlerta').textContent = "Erro ao carregar tempo em alerta";
                    document.getElementById('tempEstavel').textContent = "Erro ao carregar tempo estável";
                });
        }


        // Função para criar ou atualizar o gráfico de alertas
        function atualizarGraficoAlertas() {
            // Verifica se o gráfico de alertas já foi criado, caso contrário, cria um novo
            if (alertPieChartInstance) {
                alertPieChartInstance.destroy(); // Destruir o gráfico antes de criar um novo
                alertPieChartInstance = null; // Certifique-se de que a instância seja nula após a destruição
            }

            const alertPieChartCanvas = document.getElementById('alertPieChart');
            const alertPieChartCtx = alertPieChartCanvas.getContext('2d');

            // Busca os dados dos alertas
            fetch('guilherme/obterQtdAlertasRamCpu')
                .then(response => response.json())
                .then(data => {
                    console.log('Dados recebidos dos alertas:', data);  // Verifique o formato dos dados

                    // Verifique se os dados contêm as chaves esperadas
                    const totalAlertasCPU = data[0].totalAlertasCPU || 0;
                    const totalAlertasRAM = data[0].totalAlertasRAM || 0;

                    console.log('Total Alertas de RAM:', totalAlertasRAM);
                    console.log('Total Alertas de CPU:', totalAlertasCPU);

                    // Soma os alertas de CPU e RAM
                    const totalAlertas = totalAlertasCPU + totalAlertasRAM;

                    // Atualiza a contagem total de alertas críticos
                    document.getElementById('alertaCritico').textContent = `${totalAlertas} Alertas Críticos`;

                    // Cria um novo gráfico de barras para os alertas
                    alertPieChartInstance = new Chart(alertPieChartCtx, {
                        type: 'bar',
                        data: {
                            labels: ['Alertas de RAM', 'Alertas de CPU'],
                            datasets: [{
                                data: [totalAlertasRAM, totalAlertasCPU],
                                backgroundColor: ['rgba(255, 76, 76, 0.8)', 'rgba(255, 215, 0, 0.8)']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                title: {
                                    display: true,
                                    text: 'Distribuição de alertas durante o dia',
                                    font: { size: 20, weight: 'bold' },
                                    color: '#000'
                                },
                                tooltip: {
                                    titleFont: { size: 16, weight: 'bold', color: '#000' },
                                    bodyFont: { size: 16, weight: 'bold', color: '#000' }
                                }
                            },
                        }
                    });
                })
                .catch(error => {
                    console.error('Erro ao obter os dados de alertas:', error);
                    document.getElementById('alertaCritico').textContent = "Erro ao carregar alertas";
                });
        }

        function atualizarInfoAlertas() {
            fetch("guilherme/obterInfoAlertas")  // Verifique se essa URL está correta
                .then(response => {
                    console.log("Resposta recebida:", response);  // Log da resposta
                    if (!response.ok) {
                        throw new Error("Erro na requisição: " + response.statusText);  // Verifica se a resposta foi bem-sucedida
                    }
                    return response.json();  // Converte a resposta para JSON
                })
                .then(data => {
                    console.log("Dados recebidos:", data);  // Verifica os dados recebidos

                    const alertDetailsContainer = document.getElementById("alert-details-container");
                    alertDetailsContainer.innerHTML = ''; // Limpar o conteúdo existente

                    data.forEach(alerta => {
                        // Criar as divs para os alertas
                        const alertaDiv = document.createElement("div");
                        alertaDiv.classList.add("alert-detail-card");

                        // Criar a bolinha de cor
                        const bolinha = document.createElement("span");
                        bolinha.classList.add("alert-bolinha");

                        // Modificar o nome do componente para exibir apenas CPU ou RAM
                        let nomeComponenteExibido = alerta.nomeComponente;
                        if (nomeComponenteExibido === 'PercCPU') {
                            nomeComponenteExibido = 'CPU';  // Substitui "PercCPU" por "CPU"
                            alertaDiv.classList.add("amarela");  // Adiciona a classe ao card
                            bolinha.classList.add("amarela");
                        } else if (nomeComponenteExibido === 'PercMEM') {
                            nomeComponenteExibido = 'RAM';  // Substitui "PercMEM" por "RAM"
                            alertaDiv.classList.add("vermelha");  // Adiciona a classe ao card
                            bolinha.classList.add("vermelha");
                        }

                        // Montar o conteúdo do alerta
                        alertaDiv.innerHTML = `
                    <div class="alert-description">
                        <strong>${nomeComponenteExibido}</strong> - ${alerta.descricaoAlerta} - Data: ${new Date(alerta.dataAlerta).toLocaleString()}
                    </div>
                `;
                        alertaDiv.prepend(bolinha); // Coloca a bolinha antes da descrição

                        // Adicionar a div ao container
                        alertDetailsContainer.appendChild(alertaDiv);
                    });
                })
                .catch(error => {
                    console.error("Erro ao buscar dados:", error);  // Exibe o erro no console
                    alert("Ocorreu um erro ao tentar buscar os dados: " + error.message);  // Exibe uma mensagem para o usuário
                });
        }


        // Chama as funções de atualização periodicamente
        setInterval(atualizarGraficoAlertas, 8000); // Atualiza o gráfico de alertas
        setInterval(fetchDataAndUpdateChart, 8000);  // Atualiza a CPU
        setInterval(fetchDataAndUpdateRamChart, 8000);  // Atualiza a RAM
        setInterval(updateTemp, 8000);
        setInterval(atualizarInfoAlertas, 8000);

        // Chama as funções de atualização inicialmente
        fetchDataAndUpdateChart();
        fetchDataAndUpdateRamChart();
        atualizarGraficoAlertas();
        atualizarInfoAlertas
    }

    async function gerarResposta() {
        const pergunta = document.getElementById('pergunta').value;

        // URL da API BobIA-1.0.2
        const response = await fetch('http://localhost:3001/perguntar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ pergunta })
        });

        const data = await response.json();
        document.getElementById("pergunta").value = '';

        // Seleciona o card de resposta
        const respostaCard = document.getElementById('resposta');

        // Exibe o card de resposta
        respostaCard.style.display = "block";

        // Adiciona o conteúdo da resposta
        document.getElementById('resposta-texto').innerText = data.resultado;

        // Exibe o ícone de fechar
        const fecharIcone = document.querySelector('.fechar-icone');
        fecharIcone.style.display = 'block'; // Garante que o ícone apareça

        // Aplica o efeito de fundo ofuscado
        document.body.classList.add('ofuscado');
    }

    document.getElementById('gerarRelatorio').addEventListener('click', function () {
    // Função para coletar dados dos fetchs
    async function coletarDados() {
        try {
            // Realizando as requisições
            const cpuData = await fetch('guilherme/obterPercentualCpu').then(res => res.json());
            const ramData = await fetch('guilherme/obterPercentualRam').then(res => res.json());
            const alertasData = await fetch('guilherme/obterQtdAlertasRamCpu').then(res => res.json());
            const tempoAlertaData = await fetch('guilherme/obterTempAlertas').then(res => res.json());
            const infoAlertasData = await fetch('guilherme/obterInfoAlertas').then(res => res.json()); // Aqui está a adição

            // Verificar se a quantidade de alertas foi corretamente retornada
            const totalAlertasCPU = alertasData[0]?.totalAlertasCPU || 0;
            const totalAlertasRAM = alertasData[0]?.totalAlertasRAM || 0;

            // Estrutura os dados para o envio
            const relatorioData = {
                descricao: "Relatório detalhado sobre o desempenho dos sistemas monitorados. Foco nos dados de uso de CPU, RAM, alertas e tempo de ociosidade.",
                cpu: {
                    descricao: "Dados sobre o uso de CPU ao longo do dia.",
                    historico: cpuData.map(item => ({
                        horario: item.horario,
                        uso: item.percentualCpu
                    }))
                },
                ram: {
                    descricao: "Dados sobre o uso de RAM ao longo do dia.",
                    historico: ramData.map(item => ({
                        horario: item.horario,
                        uso: item.percentualRam
                    }))
                },
                alertas: {
                    descricao: "Dados sobre os alertas gerados ao longo do dia.",
                    totalAlertasCPU: totalAlertasCPU,
                    totalAlertasRAM: totalAlertasRAM,
                    detalhes: `Foram registrados ${totalAlertasCPU} alertas de CPU e ${totalAlertasRAM} alertas de RAM.`
                },
                tempoEstavelEAlerta: {
                    descricao: "Porcentagem de tempo que o sistema permaneceu em estado estável e alerta.",
                    porcentagemAlerta: tempoAlertaData[0]?.porcentagemAlertas || 0,
                    porcentagemEstavel: tempoAlertaData[0]?.porcentagemSemAlertas || 0,
                },
                infoAlertas: {
                    descricao: "Detalhes dos alertas de CPU e RAM.",
                    dados: infoAlertasData.map(alerta => ({
                        componente: alerta.nomeComponente === 'PercCPU' ? 'CPU' : 'RAM',
                        descricaoAlerta: alerta.descricaoAlerta,
                        dataAlerta: new Date(alerta.dataAlerta).toLocaleString()
                    }))
                }
            };

            // Montando a pergunta com os dados já prontos
            const perguntaComDados = `
            Análise detalhada do desempenho do sistema com base nos seguintes dados:

            1. Uso de CPU:
                ${cpuData.map(item => `Horário: ${item.horario}, Uso: ${item.percentualCpu}%`).join('\n')}

            2. Uso de RAM:
                ${ramData.map(item => `Horário: ${item.horario}, Uso: ${item.percentualRam}%`).join('\n')}

            3. Alertas:
                CPU: ${totalAlertasCPU} alertas
                RAM: ${totalAlertasRAM} alertas

            4. Detalhes dos alertas:
                ${infoAlertasData.map(alerta => `Componente: ${alerta.nomeComponente === 'PercCPU' ? 'CPU' : 'RAM'}, Descrição: ${alerta.descricaoAlerta}, Data: ${new Date(alerta.dataAlerta).toLocaleString()}`).join('\n')}

            5. Porcentagem de tempo:
                Em alerta: ${tempoAlertaData[0]?.porcentagemAlertas || 0}%
                Estável: ${tempoAlertaData[0]?.porcentagemSemAlertas || 0}%

            Por favor, forneça uma análise detalhada e bem organizada dos dados de uso de CPU, RAM, alertas e tempo de ociosidade do sistema e faça sempre uma conclusão. O foco deve ser na explicação clara e simples desses dados, sem incluir dados relacionados ao banco de dados. Organize a resposta em tópicos e listas, e inclua descrições sobre cada aspecto dos dados apresentados.
        `;

            // Exibe no console os dados que serão enviados para a API
            console.log("Dados enviados para a API:", perguntaComDados);

            // Envia os dados para a API de geração de relatórios com uma solicitação para análise
            const response = await fetch('http://localhost:3001/perguntar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    pergunta: perguntaComDados,
                    contexto: relatorioData
                })
            });

            // Coleta a resposta da API
            const data = await response.json();

            // Verifica se a resposta da API contém um valor válido
            const respostaText = data.resultado || 'A resposta da API está vazia ou não foi definida corretamente.';

            // Exibe o card de resposta
            const respostaCard = document.getElementById('resposta');
            respostaCard.style.display = "block";

            // Adiciona a resposta da API ou mensagem de erro
            document.getElementById('resposta-texto').innerText = respostaText;

            // Exibe o ícone de fechar
            const fecharIcone = document.querySelector('.fechar-icone');
            fecharIcone.style.display = 'block';

            // Aplica o efeito de fundo ofuscado
            document.body.classList.add('ofuscado');

        } catch (error) {
            console.error('Erro ao coletar ou enviar os dados:', error);

            // Exibe a mensagem de erro da API
            const respostaCard = document.getElementById('resposta');
            respostaCard.style.display = "block";
            document.getElementById('resposta-texto').innerText = 'Erro ao coletar ou enviar os dados: ' + error.message;

            // Exibe o ícone de fechar
            const fecharIcone = document.querySelector('.fechar-icone');
            fecharIcone.style.display = 'block';

            // Aplica o efeito de fundo ofuscado
            document.body.classList.add('ofuscado');
        }
    }

    // Chama a função para coletar os dados e gerar o relatório
    coletarDados();
});




    function fecharResposta() {
        // Oculta o card de resposta
        const respostaCard = document.getElementById('resposta');
        respostaCard.style.display = "none";

        // Remove o fundo ofuscado
        document.body.classList.remove('ofuscado');
    }

    // Alternar para a seção de alertas
    document.getElementById('btn-alertas').addEventListener('click', () => {
        document.querySelector('.main-content').classList.add('hidden');
        document.getElementById('alertSection').classList.remove('hidden');
        document.getElementById('ramSection').classList.add('hidden'); // Garante que a seção de RAM esteja oculta
    });

    // Alternar para a seção de RAM
    document.getElementById('btn-ram').addEventListener('click', () => {
        document.querySelector('.main-content').classList.add('hidden');
        document.getElementById('ramSection').classList.remove('hidden');
        document.getElementById('alertSection').classList.add('hidden'); // Garante que a seção de alertas esteja oculta
    });

    // Voltar para a seção CPU a partir da RAM e da seção de alertas
    document.getElementById('btn-cpu').addEventListener('click', () => {
        document.querySelector('.main-content').classList.remove('hidden');
        document.getElementById('alertSection').classList.add('hidden');
        document.getElementById('ramSection').classList.add('hidden');
    });

    document.getElementById('btn-alertas2').addEventListener('click', () => {
        document.querySelector('.main-content').classList.add('hidden');
        document.getElementById('alertSection').classList.remove('hidden');
        document.getElementById('ramSection').classList.add('hidden'); // Garante que a seção de RAM esteja oculta
    });

    // Alternar para a seção de RAM
    document.getElementById('btn-ram2').addEventListener('click', () => {
        document.querySelector('.main-content').classList.add('hidden');
        document.getElementById('ramSection').classList.remove('hidden');
        document.getElementById('alertSection').classList.add('hidden'); // Garante que a seção de alertas esteja oculta
    });

    // Voltar para a seção CPU a partir da RAM e da seção de alertas
    document.getElementById('btn-cpu2').addEventListener('click', () => {
        document.querySelector('.main-content').classList.remove('hidden');
        document.getElementById('alertSection').classList.add('hidden');
        document.getElementById('ramSection').classList.add('hidden');
    });

    // Botões dentro da seção de alertas para alternar entre as seções corretamente
    document.getElementById('btn-back-cpu').addEventListener('click', () => {
        document.querySelector('.main-content').classList.remove('hidden');
        document.getElementById('alertSection').classList.add('hidden');
        document.getElementById('ramSection').classList.add('hidden');
    });

    document.getElementById('btn-back-ram').addEventListener('click', () => {
        document.querySelector('.main-content').classList.add('hidden');
        document.getElementById('alertSection').classList.add('hidden');
        document.getElementById('ramSection').classList.remove('hidden'); // Exibe a seção de RAM
    });

    // Alternar para a seção de alertas a partir da RAM
    document.getElementById('btn-back-alertas').addEventListener('click', () => {
        document.querySelector('.main-content').classList.add('hidden');
        document.getElementById('ramSection').classList.add('hidden');
        document.getElementById('alertSection').classList.remove('hidden'); // Exibe a seção de alertas
    });
</script>
</script>
</body>

</html>